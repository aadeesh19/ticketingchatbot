<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ticket Booking Chatbot</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
  :root {
    --green-btn: #2e8b57;     /* Rich green */
    --green-bg-light: #d6f0d6;
    --blue-btn: #1877f2;      /* Vibrant blue */
    --blue-bg-light: #d9eaff;
    --white: #ffffff;
  }
  body {
    background: var(--white);
    font-family: 'Inter', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
  }
  #chatContainer {
    display: none;
    position: fixed;
    bottom: 100px;
    right: 30px;
    z-index: 1001;
    background: var(--white);
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    width: 360px;
    max-width: 95vw;
    padding: 12px 20px 20px 20px;
    animation: fadeInScale 0.4s ease forwards;
    display: flex;
    flex-direction: column;
    border: 2px solid var(--blue-bg-light);
  }
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.85);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  #chatHeader {
    padding: 12px 16px;
    background: linear-gradient(90deg, var(--green-bg-light) 0%, var(--blue-bg-light) 100%);
    color: var(--blue-btn);
    font-size: 1.25rem;
    font-weight: 700;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  #closeChatBtn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--blue-btn);
    cursor: pointer;
  }
  #chatbox {
    background: #fff;
    height: 280px;
    overflow-y: auto;
    padding: 12px;
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-radius: 12px;
  }
  .message {
    max-width: 75%;
    padding: 12px 18px;
    border-radius: 18px;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
    line-height: 1.4;
    animation: fadeInUp 0.3s ease forwards;
    word-wrap: break-word;
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .user {
    align-self: flex-end;
    background: var(--green-btn);
    color: var(--white);
    border-bottom-right-radius: 4px;
  }
  .bot {
    align-self: flex-start;
    background: var(--blue-btn);
    color: var(--white);
    border-bottom-left-radius: 4px;
  }
  /* Bot thinking message style */
  .bot-thinking {
    align-self: flex-start;
    font-style: italic;
    color: var(--blue-btn);
    opacity: 0.7;
    background: transparent;
    border-radius: 18px;
    padding: 12px 18px;
  }
  .message a {
    color: inherit;
    text-decoration: underline;
  }
  #quickReplies {
    display: flex;
    flex-wrap: wrap;
    margin-top: 8px;
    padding: 0 6px;
  }
  .quick-reply-btn {
    background: var(--blue-bg-light);
    border-radius: 20px;
    padding: 8px 16px;
    margin: 5px 6px 0 0;
    font-weight: 600;
    color: var(--blue-btn);
    border: 2px solid var(--blue-btn);
    cursor: pointer;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.05);
    transition: transform 0.15s ease, background-color 0.3s, color 0.3s;
    user-select: none;
  }
  .quick-reply-btn:hover {
    background: var(--blue-btn);
    color: var(--white);
    transform: scale(1.05);
  }
  #inputSection {
    display: flex;
    gap: 8px;
    padding: 10px 6px 0 6px;
    align-items: center;
  }
  input[type='text'] {
    flex: 1;
    box-shadow: inset 0 2px 6px rgb(0 0 0 / 0.04);
    border-radius: 25px;
    padding: 14px 20px;
    font-size: 16px;
    border: 2px solid var(--blue-bg-light);
    outline: none;
    transition: border-color 0.3s;
    background: var(--white);
    color: var(--blue-btn);
  }
  input[type='text']:focus {
    border-color: var(--green-btn);
  }
  button#sendBtn {
    background: var(--green-btn);
    border-radius: 25px;
    font-weight: 700;
    padding: 14px 22px;
    border: none;
    color: var(--white);
    font-size: 16px;
    cursor: pointer;
    transition: background 0.35s ease;
  }
  button#sendBtn:hover:not(:disabled) {
    background: #276931;
  }
  button#sendBtn:disabled {
    background: #c1cfc0;
    cursor: not-allowed;
    color: #666;
  }
  #chatBubble {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--blue-btn);
    color: var(--white);
    font-size: 32px;
    border: none;
    box-shadow: 0 2px 10px #aaa;
    z-index: 1000;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
  }
  #chatBubble:hover {
    background: #145dbf;
  }
  @media (max-width: 400px) {
    #chatContainer {
      width: 98vw;
      bottom: 70px;
      right: 1vw;
    }
  }
  #promptMsg {
    font-style: italic;
    color: var(--blue-btn);
    margin: 8px 0 8px 10px;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
  <!-- Floating Chat Bubble Button -->
  <button id="chatBubble" title="Open Chat">ðŸ’¬</button>
  <!-- Hidden Chat Popup -->
  <div id="chatContainer" role="region" aria-label="Ticket Booking Chatbot">
    <div id="chatHeader">
      Ticket Booking Chatbot
      <button id="closeChatBtn" title="Close">&times;</button>
    </div>
    <div id="promptMsg">Say hi to start your conversation with the bot.</div>
    <div id="chatbox" aria-live="polite" aria-relevant="additions"></div>
    <div id="quickReplies" role="list"></div>
    <form id="inputSection" onsubmit="sendMessage(input.value.trim()); return false;" aria-label="Send a message to chatbot">
      <input type="text" id="userInput" placeholder="Type your message here..." autocomplete="off" aria-autocomplete="list" aria-label="Message input" />
      <button id="sendBtn" type="submit" aria-label="Send message">Send</button>
    </form>
  </div>
<script>
  const chatbox = document.getElementById('chatbox');
  const input = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const quickReplies = document.getElementById('quickReplies');
  const chatBubble = document.getElementById('chatBubble');
  const chatContainer = document.getElementById('chatContainer');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const promptMsg = document.getElementById('promptMsg');
  const userId = 'user_' + Math.floor(Math.random() * 10000);
  // Backend base URL on Render
  const backendBaseURL = 'https://render.com/docs/web-services#port-binding';
  // Toggle chat popup
  chatBubble.onclick = () => {
    chatContainer.style.display = 'flex';
    input.focus();
    chatBubble.style.display = 'none';
  };
  closeChatBtn.onclick = () => {
    chatContainer.style.display = 'none';
    chatBubble.style.display = 'flex';
  };
  // Append a message to chat, supports 'thinking' state for bot
  function appendMessage(text, sender, thinking = false) {
    const div = document.createElement('div');
    div.classList.add('message');
    if (thinking && sender === 'bot') {
      div.classList.add('bot-thinking');
      div.textContent = "Bot is typing...";
    } else {
      div.classList.add(sender);
      // Make URLs clickable
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      if (text) {
        text = text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
      }
      div.innerHTML = (sender === 'user' ? 'You: ' : 'Bot: ') + text;
    }
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
    promptMsg.style.display = 'none';
    return div;
  }
  // Show quick reply buttons
  function renderQuickReplies(replies) {
    quickReplies.innerHTML = '';
    if (!replies || replies.length === 0) return;
    replies.forEach(reply => {
      const btn = document.createElement('button');
      btn.className = 'quick-reply-btn';
      btn.type = 'button';
      btn.innerText = reply;
      btn.onclick = () => sendMessage(reply);
      quickReplies.appendChild(btn);
    });
  }
  // Send a message: posts to backend /chat and handles UI
  async function sendMessage(message) {
    if (!message || message.trim() === '') return;
    appendMessage(message, 'user');
    input.value = '';
    input.disabled = true;
    sendBtn.disabled = true;
    renderQuickReplies([]);
    // Show "bot is typing" message
    const thinkingMsg = appendMessage('', 'bot', true);
    try {
      // Wait 1.5 seconds to simulate bot thinking
      await new Promise(resolve => setTimeout(resolve, 1500));
      const response = await fetch(`${backendBaseURL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, message })
      });
      const data = await response.json();
      // Remove the thinking message and show actual reply
      thinkingMsg.remove();
      appendMessage(data.reply, 'bot');
      renderQuickReplies(data.quickReplies);
    } catch (err) {
      thinkingMsg.remove();
      appendMessage('Error reaching server.', 'bot');
      console.error(err);
    }
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
  }
  // Input event listeners
  sendBtn.addEventListener('click', () => sendMessage(input.value.trim()));
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage(input.value.trim());
    }
  });
  // Trigger greeting on first open
  let greeted = false;
  chatContainer.addEventListener('transitionend', () => {
    if (!greeted && chatContainer.style.display === 'flex') {
      sendMessage(''); // triggers greeting
      greeted = true;
    }
  });
  chatBubble.addEventListener('click', () => {
    if (!greeted) {
      sendMessage('');
      greeted = true;
    }
  });
</script>
</body>
</html>
